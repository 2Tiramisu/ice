<?xml version="1.0" encoding="utf-8"?>
<Project>
    <!--
        Dynamically add the C# generated files to the Compile project items
        but only if Ice Builder for Visual Studio is not enabled
    -->
    <ItemGroup Condition="'$(IceBuilderCsharpProps)' == ''">
        <Compile Include="@(Slice->'$(SliceCompilerOutputDir)\%(Filename).cs')" />
    </ItemGroup>
    <!--
        The SliceCompile targets build the Slice project items using Slice to C# compiler,
        the target is disabled when Ice Builder for Visual Studio is enabled.
    -->
    <Target Name="SliceCompile" BeforeTargets="CoreCompile"
            Inputs="@(Slice);$(SliceCompiler)"
            Outputs="$(SliceCompilerOutputDir)\SliceCompiler.command.log"
            Condition="@(Slice) != '' and '$(IceBuilderCsharpProps)' == ''">
        <Error Text="Unable to locate Slice to CSharp compiler SliceCompiler=$(SliceCompiler)" Condition="!Exists('$(SliceCompiler)')" />
        <MakeDir Directories="$(SliceCompilerOutputDir)"/>
        <Exec Command="$(SliceCompiler) --output-dir $(SliceCompilerOutputDir) -I$(IceHome)\slice $(SliceCompilerArgs) @(Slice->'%(Identity)', ' ')" />
        <WriteLinesToFile File="$(SliceCompilerOutputDir)\SliceCompiler.command.log"
                          Lines="Ice Home: $(IceHome);Output Dir: $(SliceOuputDir);Slice Compiler Args: $(SliceCompilerArgs)"
                          Overwrite="true" />
    </Target>

    <!--
        The SliceClean targets removes the files generated by Slice to C# compiler,
        the target is disabled when Ice Builder for Visual Studio is enabled.
    -->
    <Target Name="SliceClean" BeforeTargets="Clean" Condition="@(Slice) != '' and '$(IceBuilderCsharpProps)' == ''">
        <Delete Files="@(Slice->'$(SliceCompilerOutputDir)/%(Filename).cs')" />
        <Delete Files="$(SliceCompilerOutputDir)/SliceCompiler.command.log" />
    </Target>

</Project>
